{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POSCOMP Quiz</title>
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen bg-gray-950 text-gray-100 flex items-center justify-center p-4">
    <div class="card w-full max-w-3xl bg-gray-900 border-gray-800">
        <div class="card-header space-y-2 pb-2">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-purple-400" id="general-topic">{{ question.general_topic }}</h1>
                <div class="text-sm text-gray-400">
                    Puntaje: <span id="score">0</span>/<span id="total-answered">0</span> | 
                    Accuracy: <span id="accuracy">0</span>%
                </div>
            </div>
            <h2 class="text-lg font-medium text-gray-300" id="specific-topic">{{ question.specific_topic }}</h2>
            <span class="badge {% if question.difficulty == 'Fácil' %}border-green-600 text-green-400
                      {% elif question.difficulty == 'Medio' %}border-yellow-600 text-yellow-400
                      {% elif question.difficulty == 'Difícil' %}border-red-600 text-red-400{% endif %}" 
                  id="difficulty">
                {{ question.difficulty }}
            </span>
        </div>

        <div class="card-content space-y-6">
            <div class="text-xl font-medium py-2" id="question-text">{{ question.question_text }}</div>

            <!-- Panel de Pistas (nuevo) -->
            <div id="clues-container" class="bg-gray-800/30 p-4 rounded-md">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center text-purple-400">
                        <span class="mr-2"><i data-lucide="lightbulb" class="h-5 w-5"></i></span>
                        <h3 class="font-medium">Pistas</h3>
                    </div>
                    <button id="show-clue-btn" class="text-sm text-purple-400 hover:text-purple-300">
                        Mostrar pista
                    </button>
                </div>
                <div id="clues-list" class="space-y-2">
                    <!-- Las pistas se mostrarán aquí -->
                </div>
            </div>

            <div class="space-y-3" id="options-container">
                {% for option in question.options %}
                <button class="option-btn w-full justify-start text-left h-auto py-3 px-4 transition-all border-gray-700 hover:border-gray-500"
                        data-index="{{ forloop.counter0 }}">
                    <span class="mr-2">{{ forloop.counter|add:"64"|stringformat:"c" }}.</span> {{ option }}
                </button>
                {% endfor %}
            </div>

            <div id="action-container">
                <button id="confirm-btn" class="w-full bg-purple-700 hover:bg-purple-600 text-white py-2 px-4 rounded" disabled>
                    Confirmar respuesta
                </button>
            </div>

            <div id="result-container" class="space-y-4 animate-fadeIn hidden">
                <div id="result-message" class="flex items-center p-4 rounded-md">
                    <span id="result-icon" class="mr-2"></span>
                    <span id="result-text" class="font-medium"></span>
                </div>

                <div class="bg-gray-800/50 p-4 rounded-md">
                    <div class="flex items-center mb-2 text-purple-400">
                        <span id="book-icon" class="mr-2"></span>
                        <h3 class="font-medium">Explicación</h3>
                    </div>
                    <p class="text-gray-300" id="explanation">{{ question.explanation }}</p>
                </div>

                <button id="next-btn" class="w-full bg-purple-700 hover:bg-purple-600 text-white py-2 px-4 rounded">
                    <span>Siguiente pregunta</span>
                    <span id="next-icon" class="ml-2"></span>
                </button>
            </div>
        </div>

        <div class="card-footer text-xs text-gray-500 pt-2">
            POSCOMP Quiz - Pregunta #<span id="question-id">{{ question.id }}</span>
        </div>
    </div>

    <script>
        let currentQuestion = {{ question|safe }};
        let selectedOption = null;
        let score = 0;
        let totalAnswered = 0;
        let accuracy = 0;
        let correctIndex = {{ question.correct_index }};
        let currentClueIndex = -1; // Ninguna pista mostrada inicialmente

        // Asegurar que los iconos estén disponibles
        function initializeIcons() {
            document.getElementById('result-icon').innerHTML = `
                <i data-lucide="check-circle" class="h-5 w-5"></i>
            `;
            document.getElementById('book-icon').innerHTML = `
                <i data-lucide="book-open" class="h-5 w-5"></i>
            `;
            document.getElementById('next-icon').innerHTML = `
                <i data-lucide="chevron-right" class="h-4 w-4"></i>
            `;
            lucide.createIcons();
        }

        // Inicializar la aplicación
        function initialize() {
            console.log('Inicializando aplicación quiz...');
            console.log('Pregunta cargada:', currentQuestion);
            initializeIcons();
            setupEventListeners();
        }

        // Configurar todos los event listeners
        function setupEventListeners() {
            // Botones de opciones
            document.querySelectorAll('.option-btn').forEach(button => {
                button.addEventListener('click', handleOptionClick);
            });
            
            // Botón confirmar respuesta
            document.getElementById('confirm-btn').addEventListener('click', handleConfirmClick);
            
            // Botón siguiente pregunta
            document.getElementById('next-btn').addEventListener('click', handleNextClick);
            
            // Botón de pistas
            document.getElementById('show-clue-btn').addEventListener('click', showNextClue);
        }

        function handleOptionClick() {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-950/30');
                btn.classList.add('border-gray-700');
            });
            
            this.classList.remove('border-gray-700');
            this.classList.add('border-purple-500', 'bg-purple-950/30');
            
            selectedOption = parseInt(this.getAttribute('data-index'));
            
            document.getElementById('confirm-btn').disabled = false;
        }

        function handleConfirmClick() {
            if (selectedOption === null) return;
            
            showResult();
            
            totalAnswered++;
            if (selectedOption === correctIndex) {
                score++;
            }
            updateStats();
        }

        function handleNextClick() {
            fetch('{% url "cs_quiz:next_question" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    selected_option: selectedOption,
                    correct_index: correctIndex
                })
            })
            .then(response => response.json())
            .then(data => {
                loadNextQuestion(data);
            })
            .catch(error => console.error('Error:', error));
        }

        function showResult() {
            document.getElementById('confirm-btn').style.display = 'none';
            
            const resultContainer = document.getElementById('result-container');
            resultContainer.classList.remove('hidden');
            
            const resultMessage = document.getElementById('result-message');
            const resultText = document.getElementById('result-text');
            const resultIcon = document.getElementById('result-icon');
            
            const isCorrect = selectedOption === correctIndex;
            resultMessage.className = 'flex items-center p-4 rounded-md'; // Resetear clases
            
            if (isCorrect) {
                resultMessage.classList.add('bg-green-950/30', 'text-green-400');
                resultText.textContent = '¡Correcto!';
                resultIcon.innerHTML = '<i data-lucide="check-circle" class="h-5 w-5"></i>';
            } else {
                resultMessage.classList.add('bg-red-950/30', 'text-red-400');
                resultText.textContent = 'Incorrecto';
                resultIcon.innerHTML = '<i data-lucide="x-circle" class="h-5 w-5"></i>';
                
                const optionButtons = document.querySelectorAll('.option-btn');
                // Destacar la respuesta correcta
                if (correctIndex >= 0 && correctIndex < optionButtons.length) {
                    optionButtons[correctIndex].classList.add('border-green-500', 'bg-green-950/30');
                }
                
                // Destacar la respuesta incorrecta seleccionada
                if (selectedOption !== null && selectedOption >= 0 && selectedOption < optionButtons.length) {
                    optionButtons[selectedOption].classList.add('border-red-500', 'bg-red-950/30');
                }
            }
            
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // Mostrar todas las pistas al revelar la respuesta
            showAllClues();
            
            lucide.createIcons();
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('total-answered').textContent = totalAnswered;
            if (totalAnswered > 0) {
                accuracy = Math.round((score / totalAnswered) * 100);
            }
            document.getElementById('accuracy').textContent = accuracy;
        }

        function loadNextQuestion(question) {
            console.log('Cargando nueva pregunta:', question);
            currentQuestion = question;
            correctIndex = question.correct_index;
            
            // Resetear el índice de pistas
            currentClueIndex = -1;
            document.getElementById('clues-list').innerHTML = '';
            
            document.getElementById('general-topic').textContent = question.general_topic;
            document.getElementById('specific-topic').textContent = question.specific_topic;
            document.getElementById('question-text').textContent = question.question_text;
            document.getElementById('difficulty').textContent = question.difficulty;
            document.getElementById('explanation').textContent = question.explanation;
            document.getElementById('question-id').textContent = question.id;
            
            // Actualizar la clase del badge según dificultad
            const difficultyBadge = document.getElementById('difficulty');
            difficultyBadge.className = 'badge'; 
            if (question.difficulty === 'Fácil') {
                difficultyBadge.classList.add('border-green-600', 'text-green-400');
            } else if (question.difficulty === 'Medio') {
                difficultyBadge.classList.add('border-yellow-600', 'text-yellow-400');
            } else if (question.difficulty === 'Difícil') {
                difficultyBadge.classList.add('border-red-600', 'text-red-400');
            }
            
            // Actualizar opciones
            const optionButtons = document.querySelectorAll('.option-btn');
            optionButtons.forEach((btn, index) => {
                if (index < question.options.length) {
                    btn.innerHTML = `<span class="mr-2">${String.fromCharCode(65 + index)}.</span> ${question.options[index]}`;
                    btn.setAttribute('data-index', index);
                    btn.disabled = false;
                    btn.classList.remove('border-purple-500', 'bg-purple-950/30', 'border-green-500', 'bg-green-950/30', 'border-red-500', 'bg-red-950/30');
                    btn.classList.add('border-gray-700');
                }
            });
            
            selectedOption = null;
            
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('confirm-btn').style.display = 'block';
            document.getElementById('confirm-btn').disabled = true;
        }

        function showNextClue() {
            if (!currentQuestion || !currentQuestion.clues || currentQuestion.clues.length === 0) {
                return;
            }
            
            if (currentClueIndex < currentQuestion.clues.length - 1) {
                currentClueIndex++;
                const clue = currentQuestion.clues[currentClueIndex];
                const clueElement = document.createElement('div');
                clueElement.className = 'p-2 border-l-2 border-purple-500 pl-3 text-gray-300 animate-fadeIn';
                clueElement.textContent = clue;
                document.getElementById('clues-list').appendChild(clueElement);
                
                // Deshabilitar el botón si ya se mostraron todas las pistas
                if (currentClueIndex === currentQuestion.clues.length - 1) {
                    document.getElementById('show-clue-btn').textContent = 'Todas las pistas mostradas';
                    document.getElementById('show-clue-btn').disabled = true;
                    document.getElementById('show-clue-btn').classList.add('opacity-50');
                }
            }
        }
        
        function showAllClues() {
            if (!currentQuestion || !currentQuestion.clues) return;
            
            const cluesList = document.getElementById('clues-list');
            cluesList.innerHTML = '';
            
            currentQuestion.clues.forEach(clue => {
                const clueElement = document.createElement('div');
                clueElement.className = 'p-2 border-l-2 border-purple-500 pl-3 text-gray-300';
                clueElement.textContent = clue;
                cluesList.appendChild(clueElement);
            });
            
            currentClueIndex = currentQuestion.clues.length - 1;
            document.getElementById('show-clue-btn').textContent = 'Todas las pistas mostradas';
            document.getElementById('show-clue-btn').disabled = true;
            document.getElementById('show-clue-btn').classList.add('opacity-50');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>